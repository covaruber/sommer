<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Giovanny Covarrubias-Pazaran" />

<meta name="date" content="2022-04-16" />

<title>Fitting genotype by environment models in sommer</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Fitting genotype by environment models in sommer</h1>
<h4 class="author">Giovanny Covarrubias-Pazaran</h4>
<h4 class="date">2022-04-16</h4>



<p>The sommer package was developed to provide R users a powerful and reliable multivariate mixed model solver. The package is focused on problems of the type p &gt; n (more effects to estimate than observations) and its core algorithm is coded in C++ using the Armadillo library. This package allows the user to fit mixed models with the advantage of specifying the variance-covariance structure for the random effects, specifying heterogeneous variances, and obtaining other parameters such as BLUPs, BLUEs, residuals, fitted values, variances for fixed and random effects, etc.</p>
<p>The purpose of this vignette is to show how to fit different genotype by environment (GxE) models using the sommer package:</p>
<ol style="list-style-type: decimal">
<li>Single environment model</li>
<li>Multienvironment model: Main effect model</li>
<li>Multienvironment model: Diagonal model (DG)</li>
<li>Multienvironment model: Compund symmetry model (CS)</li>
<li>Multienvironment model: Compund symmetry + diagonal model (CS+DG)</li>
<li>Multienvironment model: Unstructured model (US)</li>
<li>Multienvironment model: Random regression model (RR)</li>
<li>Multienvironment model: Other covariance structures for GxE</li>
</ol>
<p>When the breeder decides to run a trial and apply selection in a single environment (whether because the amount of seed is a limitation or there’s no availability for a location) the breeder takes the risk of selecting material for a target population of environments (TPEs) using an environment that is not representative of the larger TPE. Therefore, many breeding programs try to base their selection decision on multi-environment trial (MET) data. Models could be adjusted by adding additional information like spatial information, experimental design information, etc. In this tutorial we will focus mainly on the covariance structures for GxE and the incorporation of relationship matrices for the genotype effect.</p>
<div id="single-environment-model" class="section level2">
<h2>1) Single environment model</h2>
<p>A single-environment model is the one that is fitted when the breeding program can only afford one location, leaving out the possible information available from other environments. This will be used to further expand to GxE models.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(sommer)</span></code></pre></div>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## Loading required package: MASS</code></pre>
<pre><code>## Loading required package: lattice</code></pre>
<pre><code>## Loading required package: crayon</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">data</span>(DT_example)</span>
<span id="cb6-2"><a href="#cb6-2"></a>DT &lt;-<span class="st"> </span>DT_example</span>
<span id="cb6-3"><a href="#cb6-3"></a>A &lt;-<span class="st"> </span>A_example</span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a>ansSingle &lt;-<span class="st"> </span><span class="kw">mmer</span>(Yield<span class="op">~</span><span class="dv">1</span>,</span>
<span id="cb6-6"><a href="#cb6-6"></a>              <span class="dt">random=</span> <span class="op">~</span><span class="st"> </span><span class="kw">vs</span>(Name, <span class="dt">Gu=</span>A),</span>
<span id="cb6-7"><a href="#cb6-7"></a>              <span class="dt">rcov=</span> <span class="op">~</span><span class="st"> </span>units,</span>
<span id="cb6-8"><a href="#cb6-8"></a>              <span class="dt">data=</span>DT, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="kw">summary</span>(ansSingle)</span></code></pre></div>
<pre><code>## ============================================================
##          Multivariate Linear Mixed Model fit by REML         
## **********************  sommer 4.1  ********************** 
## ============================================================
##          logLik      AIC      BIC Method Converge
## Value -78.80875 159.6175 162.8378     NR     TRUE
## ============================================================
## Variance-Covariance components:
##                    VarComp VarCompSE Zratio Constraint
## u:Name.Yield-Yield   6.529     2.202  2.965   Positive
## units.Yield-Yield   13.868     1.633  8.494   Positive
## ============================================================
## Fixed effects:
##   Trait      Effect Estimate Std.Error t.value
## 1 Yield (Intercept)    11.74    0.4876   24.07
## ============================================================
## Groups and observations:
##        Yield
## u:Name    41
## ============================================================
## Use the &#39;$&#39; sign to access results and parameters</code></pre>
<p>In this model, the only term to be estimated is the one for the germplasm (here called <code>Name</code>). For the sake of example we have added a relationship matrix among the levels of the random effect <code>Name</code>. This is just a diagonal matrix with as many rows and columns as levels present in the random effect <code>Name</code>, but any other non-diagonal relationship matrix could be used.</p>
</div>
<div id="met-main-effect-model" class="section level2">
<h2>2) MET: main effect model</h2>
<p>A multi-environment model is the one that is fitted when the breeding program can afford more than one location. The main effect model assumes that GxE doesn’t exist and that the main genotype effect plus the fixed effect for environment is enough to predict the genotype effect in all locations of interest.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>ansMain &lt;-<span class="st"> </span><span class="kw">mmer</span>(Yield<span class="op">~</span>Env,</span>
<span id="cb8-2"><a href="#cb8-2"></a>              <span class="dt">random=</span> <span class="op">~</span><span class="st"> </span><span class="kw">vs</span>(Name, <span class="dt">Gu=</span>A),</span>
<span id="cb8-3"><a href="#cb8-3"></a>              <span class="dt">rcov=</span> <span class="op">~</span><span class="st"> </span>units,</span>
<span id="cb8-4"><a href="#cb8-4"></a>              <span class="dt">data=</span>DT, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="kw">summary</span>(ansMain)</span></code></pre></div>
<pre><code>## ============================================================
##          Multivariate Linear Mixed Model fit by REML         
## **********************  sommer 4.1  ********************** 
## ============================================================
##          logLik      AIC      BIC Method Converge
## Value -32.59421 71.18842 80.84949     NR     TRUE
## ============================================================
## Variance-Covariance components:
##                    VarComp VarCompSE Zratio Constraint
## u:Name.Yield-Yield   4.856    1.5233  3.188   Positive
## units.Yield-Yield    8.109    0.9615  8.434   Positive
## ============================================================
## Fixed effects:
##   Trait      Effect Estimate Std.Error t.value
## 1 Yield (Intercept)   16.385    0.5849  28.012
## 2 Yield  EnvCA.2012   -5.688    0.5741  -9.908
## 3 Yield  EnvCA.2013   -6.218    0.6107 -10.182
## ============================================================
## Groups and observations:
##        Yield
## u:Name    41
## ============================================================
## Use the &#39;$&#39; sign to access results and parameters</code></pre>
</div>
<div id="met-diagonal-model-dg" class="section level2">
<h2>3) MET: diagonal model (DG)</h2>
<p>A multi-environment model is the one that is fitted when the breeding program can afford more than one location. The diagonal model assumes that GxE exists and that the genotype variation is expressed differently at each location, therefore fitting a variance component for the genotype effect at each location. The main drawback is that this model assumes no covariance among locations, as if genotypes were independent (despite the fact that is the same genotypes). The fixed effect for environment plus the location-specific BLUP is used to predict the genotype effect in each locations of interest.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>ansDG &lt;-<span class="st"> </span><span class="kw">mmer</span>(Yield<span class="op">~</span>Env,</span>
<span id="cb10-2"><a href="#cb10-2"></a>              <span class="dt">random=</span> <span class="op">~</span><span class="st"> </span><span class="kw">vs</span>(<span class="kw">ds</span>(Env),Name, <span class="dt">Gu=</span>A),</span>
<span id="cb10-3"><a href="#cb10-3"></a>              <span class="dt">rcov=</span> <span class="op">~</span><span class="st"> </span>units,</span>
<span id="cb10-4"><a href="#cb10-4"></a>              <span class="dt">data=</span>DT, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="kw">summary</span>(ansDG)</span></code></pre></div>
<pre><code>## ============================================================
##          Multivariate Linear Mixed Model fit by REML         
## **********************  sommer 4.1  ********************** 
## ============================================================
##          logLik      AIC      BIC Method Converge
## Value -21.04157 48.08315 57.74421     NR     TRUE
## ============================================================
## Variance-Covariance components:
##                          VarComp VarCompSE Zratio Constraint
## CA.2011:Name.Yield-Yield  17.493    6.1099  2.863   Positive
## CA.2012:Name.Yield-Yield   5.337    1.7662  3.022   Positive
## CA.2013:Name.Yield-Yield   7.884    2.5526  3.089   Positive
## units.Yield-Yield          4.381    0.6493  6.747   Positive
## ============================================================
## Fixed effects:
##   Trait      Effect Estimate Std.Error t.value
## 1 Yield (Intercept)   16.621     0.948  17.532
## 2 Yield  EnvCA.2012   -5.958     1.045  -5.699
## 3 Yield  EnvCA.2013   -6.662     1.098  -6.067
## ============================================================
## Groups and observations:
##              Yield
## CA.2011:Name    41
## CA.2012:Name    41
## CA.2013:Name    41
## ============================================================
## Use the &#39;$&#39; sign to access results and parameters</code></pre>
</div>
<div id="met-compund-symmetry-model-cs" class="section level2">
<h2>4) MET: compund symmetry model (CS)</h2>
<p>A multi-environment model is the one that is fitted when the breeding program can afford more than one location. The compound symmetry model assumes that GxE exists and that a main genotype variance-covariance component is expressed across all location. In addition, it assumes that a main genotype-by-environment variance is expressed across all locations. The main drawback is that the model assumes the same variance and covariance among locations. The fixed effect for environment plus the main effect for BLUP plus genotype-by-environment effect is used to predict the genotype effect in each location of interest.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>E &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">length</span>(<span class="kw">unique</span>(DT<span class="op">$</span>Env)))</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="kw">rownames</span>(E) &lt;-<span class="st"> </span><span class="kw">colnames</span>(E) &lt;-<span class="st"> </span><span class="kw">unique</span>(DT<span class="op">$</span>Env)</span>
<span id="cb12-3"><a href="#cb12-3"></a>EA &lt;-<span class="st"> </span><span class="kw">kronecker</span>(E,A, <span class="dt">make.dimnames =</span> <span class="ot">TRUE</span>)</span>
<span id="cb12-4"><a href="#cb12-4"></a>ansCS &lt;-<span class="st"> </span><span class="kw">mmer</span>(Yield<span class="op">~</span>Env,</span>
<span id="cb12-5"><a href="#cb12-5"></a>              <span class="dt">random=</span> <span class="op">~</span><span class="st"> </span><span class="kw">vs</span>(Name, <span class="dt">Gu=</span>A) <span class="op">+</span><span class="st"> </span><span class="kw">vs</span>(Env<span class="op">:</span>Name, <span class="dt">Gu=</span>EA),</span>
<span id="cb12-6"><a href="#cb12-6"></a>              <span class="dt">rcov=</span> <span class="op">~</span><span class="st"> </span>units,</span>
<span id="cb12-7"><a href="#cb12-7"></a>              <span class="dt">data=</span>DT, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="kw">summary</span>(ansCS)</span></code></pre></div>
<pre><code>## ============================================================
##          Multivariate Linear Mixed Model fit by REML         
## **********************  sommer 4.1  ********************** 
## ============================================================
##          logLik      AIC      BIC Method Converge
## Value -20.14538 46.29075 55.95182     NR     TRUE
## ============================================================
## Variance-Covariance components:
##                        VarComp VarCompSE Zratio Constraint
## u:Name.Yield-Yield       3.682     1.691  2.177   Positive
## u:Env:Name.Yield-Yield   5.173     1.495  3.460   Positive
## units.Yield-Yield        4.366     0.647  6.748   Positive
## ============================================================
## Fixed effects:
##   Trait      Effect Estimate Std.Error t.value
## 1 Yield (Intercept)   16.496    0.6855  24.065
## 2 Yield  EnvCA.2012   -5.777    0.7558  -7.643
## 3 Yield  EnvCA.2013   -6.380    0.7960  -8.015
## ============================================================
## Groups and observations:
##            Yield
## u:Name        41
## u:Env:Name   123
## ============================================================
## Use the &#39;$&#39; sign to access results and parameters</code></pre>
</div>
<div id="met-compund-symmetry-plus-diagonal-csdiag" class="section level2">
<h2>5) MET: compund symmetry plus diagonal (CS+DIAG)</h2>
<p>A multi-environment model is the one that is fitted when the breeding program can afford more than one location. The compound symmetry plus diagonal model is very similar to the CS model assuming that GxE exist and that a main genotype variance-covariance component is expressed across all location. In addition, it assumes that a location-specific genotype-by-environment variance is expressed in each location. The main drawback is that the model assumes the same covariance among locations. The fixed effect for environment plus the main effect BLUP plus environment-specific genotype-by-environment effect is used to predict the genotype effect in each location of interest.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>ansMain &lt;-<span class="st"> </span><span class="kw">mmer</span>(Yield<span class="op">~</span>Env,</span>
<span id="cb14-2"><a href="#cb14-2"></a>              <span class="dt">random=</span> <span class="op">~</span><span class="st"> </span><span class="kw">vs</span>(Name, <span class="dt">Gu=</span>A) <span class="op">+</span><span class="st"> </span><span class="kw">vs</span>(<span class="kw">ds</span>(Env),Name, <span class="dt">Gu=</span>A),</span>
<span id="cb14-3"><a href="#cb14-3"></a>              <span class="dt">rcov=</span> <span class="op">~</span><span class="st"> </span>units,</span>
<span id="cb14-4"><a href="#cb14-4"></a>              <span class="dt">data=</span>DT, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="kw">summary</span>(ansMain)</span></code></pre></div>
<pre><code>## ============================================================
##          Multivariate Linear Mixed Model fit by REML         
## **********************  sommer 4.1  ********************** 
## ============================================================
##          logLik      AIC      BIC Method Converge
## Value -18.16164 42.32327 51.98434     NR     TRUE
## ============================================================
## Variance-Covariance components:
##                          VarComp VarCompSE Zratio Constraint
## u:Name.Yield-Yield         2.965    1.5055  1.969   Positive
## CA.2011:Name.Yield-Yield  10.424    4.4544  2.340   Positive
## CA.2012:Name.Yield-Yield   2.658    1.8032  1.474   Positive
## CA.2013:Name.Yield-Yield   5.702    2.5113  2.271   Positive
## units.Yield-Yield          4.398    0.6517  6.748   Positive
## ============================================================
## Fixed effects:
##   Trait      Effect Estimate Std.Error t.value
## 1 Yield (Intercept)   16.511    0.8269  19.967
## 2 Yield  EnvCA.2012   -5.809    0.8593  -6.760
## 3 Yield  EnvCA.2013   -6.423    0.9358  -6.864
## ============================================================
## Groups and observations:
##              Yield
## u:Name          41
## CA.2011:Name    41
## CA.2012:Name    41
## CA.2013:Name    41
## ============================================================
## Use the &#39;$&#39; sign to access results and parameters</code></pre>
</div>
<div id="met-unstructured-model-us" class="section level2">
<h2>6) MET: unstructured model (US)</h2>
<p>A multi-environment model is the one that is fitted when the breeding program can afford more than one location. The unstructured model is the most flexible model assuming that GxE exists and that an environment-specific variance exists in addition to as many covariances for each environment-to-environment combinations. The main drawback is that is difficult to make this models converge because of the large number of variance components, the fact that some of these variance or covariance components are zero, and the difficulty in choosing good starting values. The fixed effect for environment plus the environment specific BLUP (adjusted by covariances) is used to predict the genotype effect in each location of interest.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>ansUS &lt;-<span class="st"> </span><span class="kw">mmer</span>(Yield<span class="op">~</span>Env,</span>
<span id="cb16-2"><a href="#cb16-2"></a>              <span class="dt">random=</span> <span class="op">~</span><span class="st"> </span><span class="kw">vs</span>(<span class="kw">us</span>(Env),Name, <span class="dt">Gu=</span>A),</span>
<span id="cb16-3"><a href="#cb16-3"></a>              <span class="dt">rcov=</span> <span class="op">~</span><span class="st"> </span>units,</span>
<span id="cb16-4"><a href="#cb16-4"></a>              <span class="dt">data=</span>DT, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="kw">summary</span>(ansUS)</span></code></pre></div>
<pre><code>## ==================================================================
##             Multivariate Linear Mixed Model fit by REML            
## *************************  sommer 4.1  ************************* 
## ==================================================================
##          logLik      AIC      BIC Method Converge
## Value -14.20951 34.41901 44.08008     NR     TRUE
## ==================================================================
## Variance-Covariance components:
##                                  VarComp VarCompSE Zratio Constraint
## CA.2011:Name.Yield-Yield          15.994     5.381  2.972   Positive
## CA.2012:CA.2011:Name.Yield-Yield   6.172     2.503  2.465   Unconstr
## CA.2012:Name.Yield-Yield           5.273     1.750  3.013   Positive
## CA.2013:CA.2011:Name.Yield-Yield   6.366     3.069  2.074   Unconstr
## CA.2013:CA.2012:Name.Yield-Yield   0.376     1.535  0.245   Unconstr
## CA.2013:Name.Yield-Yield           7.689     2.490  3.088   Positive
## units.Yield-Yield                  4.386     0.650  6.748   Positive
## ==================================================================
## Fixed effects:
##   Trait      Effect Estimate Std.Error t.value
## 1 Yield (Intercept)   16.341    0.8141  20.072
## 2 Yield  EnvCA.2012   -5.696    0.7406  -7.692
## 3 Yield  EnvCA.2013   -6.286    0.8202  -7.664
## ==================================================================
## Groups and observations:
##                      Yield
## CA.2011:Name            41
## CA.2012:CA.2011:Name    82
## CA.2012:Name            41
## CA.2013:CA.2011:Name    82
## CA.2013:CA.2012:Name    82
## CA.2013:Name            41
## ==================================================================
## Use the &#39;$&#39; sign to access results and parameters</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># adjust variance BLUPs by adding covariances</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="co"># ansUS$U[1:6] &lt;- unsBLUP(ansUS$U[1:6])</span></span></code></pre></div>
</div>
<div id="met-random-regression-model" class="section level2">
<h2>7) MET: random regression model</h2>
<p>A multi-environment model is the one that is fitted when the breeding program can afford more than one location. The random regression model assumes that the environment can be seen as a continuous variable and therefore a variance component for the intercept and a variance component for the slope can be fitted. The number of variance components will depend on the order of the Legendre polynomial fitted.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">library</span>(orthopolynom)</span></code></pre></div>
<pre><code>## Loading required package: polynom</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>DT<span class="op">$</span>EnvN &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.factor</span>(DT<span class="op">$</span>Env))</span>
<span id="cb21-2"><a href="#cb21-2"></a>ansRR &lt;-<span class="st"> </span><span class="kw">mmer</span>(Yield<span class="op">~</span>Env,</span>
<span id="cb21-3"><a href="#cb21-3"></a>              <span class="dt">random=</span> <span class="op">~</span><span class="st"> </span><span class="kw">vs</span>(<span class="kw">leg</span>(EnvN,<span class="dv">1</span>),Name),</span>
<span id="cb21-4"><a href="#cb21-4"></a>              <span class="dt">rcov=</span> <span class="op">~</span><span class="st"> </span>units,</span>
<span id="cb21-5"><a href="#cb21-5"></a>              <span class="dt">data=</span>DT, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="kw">summary</span>(ansRR)</span></code></pre></div>
<pre><code>## ============================================================
##          Multivariate Linear Mixed Model fit by REML         
## **********************  sommer 4.1  ********************** 
## ============================================================
##          logLik      AIC      BIC Method Converge
## Value -27.70318 61.40636 71.06743     NR     TRUE
## ============================================================
## Variance-Covariance components:
##                       VarComp VarCompSE Zratio Constraint
## leg0:Name.Yield-Yield  10.392    3.1473  3.302   Positive
## leg1:Name.Yield-Yield   2.079    0.9792  2.123   Positive
## units.Yield-Yield       6.297    0.8442  7.459   Positive
## ============================================================
## Fixed effects:
##   Trait      Effect Estimate Std.Error t.value
## 1 Yield (Intercept)   16.541    0.6770  24.432
## 2 Yield  EnvCA.2012   -5.832    0.6425  -9.078
## 3 Yield  EnvCA.2013   -6.472    0.8239  -7.854
## ============================================================
## Groups and observations:
##           Yield
## leg0:Name    41
## leg1:Name    41
## ============================================================
## Use the &#39;$&#39; sign to access results and parameters</code></pre>
<p>In addition, an unstructured, diagonal or other variance-covariance structure can be put on top of the polynomial model:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="kw">library</span>(orthopolynom)</span>
<span id="cb23-2"><a href="#cb23-2"></a>DT<span class="op">$</span>EnvN &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.factor</span>(DT<span class="op">$</span>Env))</span>
<span id="cb23-3"><a href="#cb23-3"></a>ansRR &lt;-<span class="st"> </span><span class="kw">mmer</span>(Yield<span class="op">~</span>Env,</span>
<span id="cb23-4"><a href="#cb23-4"></a>              <span class="dt">random=</span> <span class="op">~</span><span class="st"> </span><span class="kw">vs</span>(<span class="kw">us</span>(<span class="kw">leg</span>(EnvN,<span class="dv">1</span>)),Name),</span>
<span id="cb23-5"><a href="#cb23-5"></a>              <span class="dt">rcov=</span> <span class="op">~</span><span class="st"> </span>units,</span>
<span id="cb23-6"><a href="#cb23-6"></a>              <span class="dt">data=</span>DT, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="kw">summary</span>(ansRR)</span></code></pre></div>
<pre><code>## ============================================================
##          Multivariate Linear Mixed Model fit by REML         
## **********************  sommer 4.1  ********************** 
## ============================================================
##          logLik      AIC      BIC Method Converge
## Value -25.56967 57.13935 66.80042     NR     TRUE
## ============================================================
## Variance-Covariance components:
##                            VarComp VarCompSE Zratio Constraint
## leg0:Name.Yield-Yield       10.791    3.2745  3.295   Positive
## leg1:leg0:Name.Yield-Yield  -2.428    1.3699 -1.772   Unconstr
## leg1:Name.Yield-Yield        2.286    1.0404  2.197   Positive
## units.Yield-Yield            6.260    0.8421  7.434   Positive
## ============================================================
## Fixed effects:
##   Trait      Effect Estimate Std.Error t.value
## 1 Yield (Intercept)   16.501    0.7778  21.216
## 2 Yield  EnvCA.2012   -5.791    0.6704  -8.638
## 3 Yield  EnvCA.2013   -6.476    0.8554  -7.570
## ============================================================
## Groups and observations:
##                Yield
## leg0:Name         41
## leg1:leg0:Name    82
## leg1:Name         41
## ============================================================
## Use the &#39;$&#39; sign to access results and parameters</code></pre>
</div>
<div id="other-gxe-covariance-structures" class="section level2">
<h2>8) Other GxE covariance structures</h2>
<p>Although not very commonly used in GxE models, the autoregressive of order 1 (AR1) and other covariance structures could be used in the GxE modeling. Here we show how to do it (not recommending it).</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>E &lt;-<span class="st"> </span><span class="kw">AR1</span>(DT<span class="op">$</span>Env) <span class="co"># can be AR1() or CS(), etc.</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="kw">rownames</span>(E) &lt;-<span class="st"> </span><span class="kw">colnames</span>(E) &lt;-<span class="st"> </span><span class="kw">unique</span>(DT<span class="op">$</span>Env)</span>
<span id="cb25-3"><a href="#cb25-3"></a>EA &lt;-<span class="st"> </span><span class="kw">kronecker</span>(E,A, <span class="dt">make.dimnames =</span> <span class="ot">TRUE</span>)</span>
<span id="cb25-4"><a href="#cb25-4"></a>ansCS &lt;-<span class="st"> </span><span class="kw">mmer</span>(Yield<span class="op">~</span>Env,</span>
<span id="cb25-5"><a href="#cb25-5"></a>              <span class="dt">random=</span> <span class="op">~</span><span class="st"> </span><span class="kw">vs</span>(Name, <span class="dt">Gu=</span>A) <span class="op">+</span><span class="st"> </span><span class="kw">vs</span>(Env<span class="op">:</span>Name, <span class="dt">Gu=</span>EA),</span>
<span id="cb25-6"><a href="#cb25-6"></a>              <span class="dt">rcov=</span> <span class="op">~</span><span class="st"> </span>units,</span>
<span id="cb25-7"><a href="#cb25-7"></a>              <span class="dt">data=</span>DT, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="kw">summary</span>(ansCS)</span></code></pre></div>
<pre><code>## ============================================================
##          Multivariate Linear Mixed Model fit by REML         
## **********************  sommer 4.1  ********************** 
## ============================================================
##          logLik      AIC     BIC Method Converge
## Value -19.39067 44.78134 54.4424     NR     TRUE
## ============================================================
## Variance-Covariance components:
##                        VarComp VarCompSE Zratio Constraint
## u:Name.Yield-Yield       2.225    1.7536  1.269   Positive
## u:Env:Name.Yield-Yield   6.424    1.8293  3.512   Positive
## units.Yield-Yield        4.334    0.6418  6.752   Positive
## ============================================================
## Fixed effects:
##   Trait      Effect Estimate Std.Error t.value
## 1 Yield (Intercept)   16.484    0.6735  24.474
## 2 Yield  EnvCA.2012   -5.780    0.7365  -7.848
## 3 Yield  EnvCA.2013   -6.372    0.7799  -8.170
## ============================================================
## Groups and observations:
##            Yield
## u:Name        41
## u:Env:Name   123
## ============================================================
## Use the &#39;$&#39; sign to access results and parameters</code></pre>
</div>
<div id="final-remarks" class="section level2">
<h2>Final remarks</h2>
<p>Keep in mind that sommer uses the direct inversion (DI) algorithm which can be very slow for large datasets. The package is focused on problems of the type p &gt; n (more random effect levels than observations) and models with dense covariance structures. For example, for experiments with dense covariance structures with low-replication (i.e. 2000 records from 1000 individuals replicated twice with a covariance structure of 1000x1000) sommer will be faster than MME-based software. Also for genomic problems with large number of random effect levels, i.e. 300 individuals (n) with 100,000 genetic markers (p). For highly replicated trials with small number of individuals and covariance structures or n &gt; p (i.e. 2000 records from 200 individuals replicated 10 times with covariance structure of 200x200) asreml or other MME-based algorithms will be much faster and we recommend you opt for those.</p>
</div>
<div id="literature" class="section level2">
<h2>Literature</h2>
<p>Covarrubias-Pazaran G. 2016. Genome assisted prediction of quantitative traits using the R package sommer. PLoS ONE 11(6):1-15.</p>
<p>Covarrubias-Pazaran G. 2018. Software update: Moving the R package sommer to multivariate mixed models for genome-assisted prediction. doi: <a href="https://doi.org/10.1101/354639" class="uri">https://doi.org/10.1101/354639</a></p>
<p>Bernardo Rex. 2010. Breeding for quantitative traits in plants. Second edition. Stemma Press. 390 pp.</p>
<p>Gilmour et al. 1995. Average Information REML: An efficient algorithm for variance parameter estimation in linear mixed models. Biometrics 51(4):1440-1450.</p>
<p>Henderson C.R. 1975. Best Linear Unbiased Estimation and Prediction under a Selection Model. Biometrics vol. 31(2):423-447.</p>
<p>Kang et al. 2008. Efficient control of population structure in model organism association mapping. Genetics 178:1709-1723.</p>
<p>Lee, D.-J., Durban, M., and Eilers, P.H.C. (2013). Efficient two-dimensional smoothing with P-spline ANOVA mixed models and nested bases. Computational Statistics and Data Analysis, 61, 22 - 37.</p>
<p>Lee et al. 2015. MTG2: An efficient algorithm for multivariate linear mixed model analysis based on genomic information. Cold Spring Harbor. doi: <a href="http://dx.doi.org/10.1101/027201" class="uri">http://dx.doi.org/10.1101/027201</a>.</p>
<p>Maier et al. 2015. Joint analysis of psychiatric disorders increases accuracy of risk prediction for schizophrenia, bipolar disorder, and major depressive disorder. Am J Hum Genet; 96(2):283-294.</p>
<p>Rodriguez-Alvarez, Maria Xose, et al. Correcting for spatial heterogeneity in plant breeding experiments with P-splines. Spatial Statistics 23 (2018): 52-71.</p>
<p>Searle. 1993. Applying the EM algorithm to calculating ML and REML estimates of variance components. Paper invited for the 1993 American Statistical Association Meeting, San Francisco.</p>
<p>Yu et al. 2006. A unified mixed-model method for association mapping that accounts for multiple levels of relatedness. Genetics 38:203-208.</p>
<p>Tunnicliffe W. 1989. On the use of marginal likelihood in time series model estimation. JRSS 51(1):15-27.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
